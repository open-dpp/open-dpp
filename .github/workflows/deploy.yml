name: Deploy Docker image via SSH

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (e.g., latest, main, v1.2.3, sha)'
        required: false
        default: latest

permissions:
  contents: read
  packages: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  IMAGE_TAG: ${{ github.event.inputs.image_tag }}
  DEPLOY_DIR: app

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.HETZNER_SSH_PORT }} ${{ secrets.HETZNER_IPV4 }} >> ~/.ssh/known_hosts

      - name: Generate docker-compose override (use prebuilt image)
        run: |
          cat > docker-compose.override.yml <<EOF
          services:
            open-dpp:
              image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
              build: null
          EOF

      - name: Copy deployment files to server
        run: |
          ssh -p ${{ secrets.HETZNER_SSH_PORT }} root@${{ secrets.HETZNER_IPV4 }} "mkdir -p ${DEPLOY_DIR}"
          rsync -az --delete -e "ssh -p ${{ secrets.HETZNER_SSH_PORT }}" \
            docker-compose.yml docker-compose.override.yml public-env \
            root@${{ secrets.HETZNER_IPV4 }}:${{ env.DEPLOY_DIR }}/

      - name: Prepare env file on server
        run: |
          ssh -p ${{ secrets.HETZNER_SSH_PORT }} root@${{ secrets.HETZNER_IPV4 }} "cd ${DEPLOY_DIR} && cp -f public-env .env || true"

      - name: Log in to GHCR on server
        run: |
          ssh -p ${{ secrets.HETZNER_SSH_PORT }} root@${{ secrets.HETZNER_IPV4 }} "echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin"

      - name: Pull and restart open-dpp service
        run: |
          ssh -p ${{ secrets.HETZNER_SSH_PORT }} root@${{ secrets.HETZNER_IPV4 }} "\
            cd ${DEPLOY_DIR} && \
            set -a; [ -f .env ] && . ./.env; set +a; \
            export AUTH_ADMIN_USERNAME='${{ secrets.AUTH_ADMIN_USERNAME }}' AUTH_ADMIN_PWD='${{ secrets.AUTH_ADMIN_PWD }}' API_SERVICE_TOKEN='${{ secrets.API_SERVICE_TOKEN }}' MISTRAL_API_KEY='${{ secrets.MISTRAL_API_KEY }}' OLLAMA_URL='${{ secrets.OLLAMA_URL }}'; \
            export SERVICE_API_HOST=\"${SERVICE_API_HOST:-api.${SERVICES_HOST_SUFFIX:-open-dpp.localhost}}\"; \
            export SERVICE_MARKETPLACE_URL=\"${SERVICE_MARKETPLACE_URL:-${MARKETPLACE_URL:-http://localhost:3000/api}}\"; \
            docker compose -f docker-compose.yml -f docker-compose.override.yml pull open-dpp && \
            docker compose -f docker-compose.yml -f docker-compose.override.yml up -d open-dpp \
          "